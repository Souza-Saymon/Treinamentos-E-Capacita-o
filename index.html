<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinamento/Capacitação Eztec</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --eztec-cereja: #D01139;
            --eztec-cacau: #350F15;
            --white-smoke: #F4F4F4;
            --grey-nickel: #CAC4C4;
            --fluent-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--white-smoke); 
            margin: 0; padding: 20px;
            color: var(--eztec-cacau);
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }

        /* Símbolo Responsivo Canto Inferior */
        .simbolo-fixo {
            position: fixed; bottom: 20px; left: 20px; 
            width: 50px; height: auto; z-index: 1000;
        }

        .card { 
            background: #ffffff; padding: 40px; border-radius: 8px;
            box-shadow: var(--fluent-shadow); max-width: 680px; width: 100%;
            border-top: 5px solid var(--eztec-cereja);
            box-sizing: border-box;
        }

        .header-logo { text-align: center; margin-bottom: 30px; }
        .header-logo img { max-width: 180px; width: 100%; height: auto; }

        h2 { font-weight: 600; font-size: 20px; text-align: center; margin-bottom: 30px; }

        /* GRID RESPONSIVO */
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 2 colunas no Desktop */
            gap: 20px; 
        }

        /* AJUSTE PARA TELEMÓVEL */
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; } /* 1 coluna no Mobile */
            .card { padding: 25px 15px; }
            .simbolo-fixo { width: 40px; bottom: 10px; left: 10px; }
            body { padding: 10px; }
        }

        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: #555; }

        input, select { 
            width: 100%; padding: 12px; 
            border: 1px solid var(--grey-nickel); 
            border-bottom: 2px solid var(--grey-nickel);
            border-radius: 4px; font-family: 'Sarabun', sans-serif; 
            font-size: 16px; /* 16px evita zoom indesejado no iPhone */
            transition: all 0.2s; outline: none; background: #fff;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            border-bottom-color: var(--eztec-cereja);
            box-shadow: 0 4px 6px -1px rgba(208, 17, 57, 0.1);
        }

        button { 
            width: 100%; padding: 18px; background-color: var(--eztec-cereja); color: white; 
            border: none; border-radius: 4px; font-weight: 700; cursor: pointer; 
            margin-top: 30px; transition: 0.3s; font-size: 16px;
            text-transform: uppercase;
        }

        button:hover { background-color: var(--eztec-cacau); transform: translateY(-1px); }

        #mensagem { text-align: center; margin-top: 20px; font-weight: 600; font-size: 14px; }

        /* Estilo Flatpickr Cereja */
        .flatpickr-day.selected { background: var(--eztec-cereja) !important; border-color: var(--eztec-cereja) !important; }
    </style>
</head>
<body>

    <img src="image_b63afa.png" alt="Símbolo Eztec" class="simbolo-fixo">

    <div class="card">
        <div class="header-logo">
            <img src="Logo_Eztec_Cereja.png" alt="Logo Eztec">
        </div>

        <h2>Treinamento / Capacitação</h2>
        
        <form id="formulario">
            <div class="grid">
                <div class="field full-width">
                    <label for="Nome">Nome completo</label>
                    <input type="text" id="Nome" placeholder="Seu nome" required>
                </div>
                
                <div class="field">
                    <label for="Departamento">Departamento</label>
                    <input type="text" id="Departamento" list="listaDepto" placeholder="Buscar..." autocomplete="off">
                    <datalist id="listaDepto"></datalist>
                </div>

                <div class="field">
                    <label for="Cargo">Cargo</label>
                    <input type="text" id="Cargo">
                </div>

                <div class="field">
                    <label for="Diretoria">Diretoria</label>
                    <select id="Diretoria" required>
                        <option value="" disabled selected>A carregar...</option>
                    </select>
                </div>

                <div class="field">
                    <label for="Divisao">Divisão</label>
                    <select id="Divisao" required>
                        <option value="" disabled selected>Selecione...</option>
                        <option value="Escritório">Escritório</option>
                        <option value="Obra">Obra</option>
                    </select>
                </div>

                <div class="field">
                    <label for="DataInicio">Data início</label>
                    <input type="text" id="DataInicio" class="datepicker" placeholder="Selecione">
                </div>
                <div class="field">
                    <label for="DataFim">Data fim</label>
                    <input type="text" id="DataFim" class="datepicker" placeholder="Selecione">
                </div>

                <div class="field">
                    <label for="HoraInicio">Hora início</label>
                    <input type="text" id="HoraInicio" class="timepicker" placeholder="00:00">
                </div>
                <div class="field">
                    <label for="HoraFim">Hora fim</label>
                    <input type="text" id="HoraFim" class="timepicker" placeholder="00:00">
                </div>

                <div class="field full-width">
                    <label for="Fornecedor">Fornecedor / facilitador</label>
                    <input type="text" id="Fornecedor">
                </div>
            </div>
            
            <button type="submit">Finalizar inscrição</button>
        </form>
        <div id="mensagem"></div>
    </div>

    <script>
        // 1. Configuração Supabase
        const SUPABASE_URL = "https://udmpjsxhspgfonzyeard.supabase.co";
        const SUPABASE_KEY = "sb_publishable_jODPibc9Km9xP2QmJ-08cA_sM75Zzsb";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. Flatpickr (Calendário e Hora)
        flatpickr(".datepicker", { locale: "pt", dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y" });
        flatpickr(".timepicker", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });

        // 3. Carregar Diretorias dinamicamente do Supabase
        async function carregarDiretorias() {
            const select = document.getElementById('Diretoria');
            const { data, error } = await supabaseClient.from('DM_Diretoria').select('Diretoria').order('Diretoria');
            if (!error) {
                select.innerHTML = '<option value="" disabled selected>Selecione a diretoria</option>';
                data.forEach(item => {
                    let opt = document.createElement('option');
                    opt.value = item.Diretoria;
                    opt.textContent = item.Diretoria;
                    select.appendChild(opt);
                });
            }
        }
        carregarDiretorias();

        // 4. Lógica de Departamento (Oracle Local via Flask)
        const inputDepto = document.getElementById('Departamento');
        const dataListDepto = document.getElementById('listaDepto');
        inputDepto.addEventListener('input', async (e) => {
            const valor = e.target.value;
            if (valor.length >= 2) {
                try {
                    const response = await fetch(`http://localhost:5000/buscar?q=${valor}`);
                    const departamentos = await response.json();
                    dataListDepto.innerHTML = "";
                    departamentos.forEach(depto => {
                        const option = document.createElement('option');
                        option.value = depto;
                        dataListDepto.appendChild(option);
                    });
                } catch (err) { console.error(err); }
            }
        });

        // 5. Envio para o Supabase
        const form = document.getElementById('formulario');
        const msgStatus = document.getElementById('mensagem');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            msgStatus.innerText = "⏳ A PROCESSAR...";
            
            const dados = {
                "Nome": document.getElementById('Nome').value,
                "Departamento": document.getElementById('Departamento').value,
                "Cargo": document.getElementById('Cargo').value,
                "Diretoria": document.getElementById('Diretoria').value,
                "Divisão": document.getElementById('Divisao').value,
                "DataInicio": document.getElementById('DataInicio').value,
                "DataFim": document.getElementById('DataFim').value,
                "HoraInicio": document.getElementById('HoraInicio').value,
                "HoraFim": document.getElementById('HoraFim').value,
                "Fornecedor/Facilitador": document.getElementById('Fornecedor').value
            };

            const { error } = await supabaseClient.from('FT_Treinamentos').insert([dados]);
            if (error) {
                msgStatus.innerText = "❌ Erro ao enviar registro.";
                msgStatus.style.color = "var(--eztec-cereja)";
            } else {
                msgStatus.innerText = "✅ INSCRIÇÃO REALIZADA COM SUCESSO!";
                msgStatus.style.color = "green";
                form.reset();
            }
        });
    </script>
</body>
</html>